<div class = 'container border border-dark' style = "border-width: 5px !important; font-family: 'Verdana'; padding:50px; padding-left:75px">
  <h2>New RCA</h2>
  <div class =  'border-top border-danger' style = 'border-width:3px !important; padding-top:40px'></div>
  <%= form_with model: @rca, local: true, id: 'form_id' do |form| %>
    <% if (@rca.errors.any?) %>
      <div class="alert alert-danger">
        <%=  @rca.errors.full_messages.first %></div>
      <% if (@rca.user.errors[:email].any?) %>
        <div class="alert alert-danger">
          <%=  @rca.user.errors.full_messages[1]%></div>
      <%end%>
    <% elsif (@rca.user.errors[:email].any?) %>
      <div class="alert alert-danger">
        <%=  @rca.user.errors.full_messages.first%></div>
    <%end%>

    <div class = 'row'>
      <p>
        <%= form.label :title, style: 'font-size:20px;'%><br>
        <%= form.text_field :title, class: 'form-control', size: '100', style: 'border-top:0; border-right:0; border-left:0; outline:none; box-shadow:none !important', placeholder: 'Title for the RCA'%>
      </p>
    </div>

    <div class = 'row'>
      <p>
        <%= form.label "Your email", style: 'font-size:20px' %><br>
        <input name = "user[email]" type = "text" class = 'form-control' style = 'border-top:0; border-right:0; border-left:0; outline:none; box-shadow:none !important' placeholder = 'xyz@go-jek.com' size = 100 value = <%= @rca.user.email %> >
      </p>
    </div>

    <div class = 'row'>
      <p>
        <%= form.label :description, style: 'font-size:20px' %><br>
        <%= form.text_area :description, class: 'form-control', style: 'resize: both; box-shadow:none !important', rows:'10', cols:'100'%>
      </p>
    </div>

    <div class = 'row'>
      <p>
        <%= form.label 'Action Items', style: 'font-size:20px' %><br>
      </p>
    </div>

    <div class = container id = 'actionitem'>
      <table class = 'table-responsive table-hover'>
        <thead>
          <tr>
            <th></th>
            <th style = 'padding-right:50px;'>Name</th>
            <th style = 'padding-right:50px;'>Status</th>
            <th style = 'padding-right:50px;'>Complete by</th>
            <th>Completed on</th>
          </tr>
        </thead>
        <tbody id = 'tablebody'>
          <tr>
            <td style = 'padding-right:20px;'><button type = 'button' style = 'display:none;' onclick = 'hide(this)'><i class = 'fa fa-times'></i></button></td>
            <td style = 'padding-right:50px;'><input type = 'text'></td>
            <td style = 'padding-right:50px;'><input type = 'button' value = 'Pending' class = 'btn btn-danger btn-sm' onclick = 'toggle(this)'></td>
            <td style = 'padding-right:50px;'><input type = 'date' min = <%= Date.today %>></td>
            <td><input type = 'date' max = <%= Date.today %>></td>
            <td><input type = 'button' value = 'New Action Item' class = 'btn btn-primary btn-sm' onclick = 'createNewActionItem(this)'></td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class = 'row'>
      <p>
        <%= form.label :status, style: 'font-size:20px'%><br>
        <%= form.select(:status) do %>
          <option value = 'Pending'>Pending</option>
          <option value = 'Completed'>Completed</option>
        <% end %>
      </p>
    </div>

    <div class = 'row'>
      <p>
        <%= form.label :team_id, style: 'font-size:20px' %><br>
        <%= form.select(:team_id) do %>
          <% @teams.each do |team| %>
            <option value = <%= team.id %>><%= team.name %></option>
          <% end %>
        <% end %>
      </p>
    </div>

    <br><br>

    <input type = 'hidden' id = 'list' name = 'actionitem[list]'>

    <div class= 'row'>
      <p>
        <%= form.submit 'Create RCA', class: 'btn btn-success', id: 'submitbutton' %>
      </p>
    </div>
  <% end %>
</div>

<script>
  function createNewActionItem(x) {
    x.style.display = 'none';
    var name = document.createElement('INPUT');
    name.setAttribute('type', 'text');
    var status = document.createElement('INPUT');
    status.setAttribute('type', 'button');
    status.value = 'Pending';
    status.className = 'btn btn-danger btn-sm';
    status.setAttribute('onclick', 'toggle(this)');
    var complete_by = document.createElement('INPUT');
    complete_by.type = 'date';
    complete_by.min = '<%= Date.today %>';
    var completed_on = document.createElement('INPUT');
    completed_on.type = 'date';
    completed_on.max = '<%= Date.today %>';
    var newactionitembutton = document.createElement('INPUT');
    newactionitembutton.type = 'button';
    newactionitembutton.value = 'New Action Item';
    newactionitembutton.setAttribute('onclick', 'createNewActionItem(this)');
    newactionitembutton.setAttribute('class', 'btn btn-primary btn-sm');
    var removebutton = document.createElement('BUTTON');
    removebutton.type = 'button';
    removebutton.setAttribute('onclick', 'hide(this)');
    var removeicon = document.createElement('I');
    removeicon.className = 'fa fa-times';
    removebutton.appendChild(removeicon);
    var parenttable = document.getElementById('tablebody');
    var tablerow = document.createElement('TR');
    var hidecolumn = document.createElement('TD');
    hidecolumn.setAttribute('style', 'padding-right:20px;');
    hidecolumn.appendChild(removebutton);
    var namecolumn = document.createElement('TD');
    namecolumn.setAttribute('style', 'padding-right:50px;');
    namecolumn.appendChild(name);
    var statuscolumn = document.createElement('TD');
    statuscolumn.setAttribute('style', 'padding-right:50px;');
    statuscolumn.appendChild(status);
    var complete_bycolumn = document.createElement('TD');
    complete_bycolumn.setAttribute('style', 'padding-right:50px;');
    complete_bycolumn.appendChild(complete_by);
    var completed_oncolumn = document.createElement('TD');
    completed_oncolumn.appendChild(completed_on);
    var newactionitembuttoncolumn = document.createElement('TD');
    newactionitembuttoncolumn.appendChild(newactionitembutton);
    tablerow.appendChild(hidecolumn);
    tablerow.appendChild(namecolumn);
    tablerow.appendChild(statuscolumn);
    tablerow.appendChild(complete_bycolumn);
    tablerow.appendChild(completed_oncolumn);
    tablerow.appendChild(newactionitembuttoncolumn);
    parenttable.appendChild(tablerow);
  }

var actionitems = new Array();

function addAndUpdateActionItems() {
  var parent = document.getElementById('tablebody')
  var actionitems_name = parent.querySelectorAll('input[type = "text"]');
  var actionitems_status = parent.querySelectorAll('input[onclick = "toggle(this)"]');
  var actionitems_complete_by = parent.querySelectorAll('input[min]');
  var actionitems_completed_on = parent.querySelectorAll('input[max]');
  for (i = 0; i < actionitems_name.length; i++){
    var object = new Object();
    object.name = actionitems_name[i].value;
    object.status = actionitems_status[i].value;
    object.complete_by = actionitems_complete_by[i].value;
    object.completed_on = actionitems_completed_on[i].value;
    console.log(object);
    actionitems[i] = object;
  }
  document.getElementById('list').value = JSON.stringify(actionitems);
}

function toggle(x) {
  if (x.value == 'Pending'){
    x.value = 'Completed';
    x.className = 'btn btn-success btn-sm';
  }
  else{
    x.value = 'Pending';
    x.className = 'btn btn-danger btn-sm';
  }
}

function hide(e){
  if (e.parentElement.parentElement.querySelector('input[onclick="createNewActionItem(this)"]').style.display != "none"){
    e.parentElement.parentElement.previousElementSibling.querySelector('input[onclick="createNewActionItem(this)"]').style.display = 'initial';
  }
  e.parentElement.parentElement.parentElement.removeChild(e.parentElement.parentElement);
}

  document.getElementById('submitbutton').addEventListener('click', function(event){
  event.preventDefault();
  addAndUpdateActionItems();
  document.getElementById('form_id').submit();
})
</script>
